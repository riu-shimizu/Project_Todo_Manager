# 🏗 プロジェクト管理＆Todo統合アプリ アーキテクチャ仕様書（現行実装版）

## 1. システム全体像

| レイヤー | 技術スタック | 役割 |
| --- | --- | --- |
| フロントエンド | React + TypeScript + Vite | SPA。プロジェクト一覧、階層エディタ、今日の Todo パネルを提供し、REST API と通信する。|
| API / プレゼンテーション | Express 5 + Zod | HTTP エンドポイント、バリデーション、アプリケーションサービス呼び出し。|
| アプリケーション | TypeScript（`projectService`） | ユースケースのオーケストレーション、階層構造の構築、進捗計算、削除や並び替えの制御。|
| ドメイン | エンティティ/値オブジェクト (`entities.ts`, `progress.ts`) | Phase/Work/Task/Todo の型、進捗計算のユーティリティ。|
| インフラ | better-sqlite3 + SQLite | Repository、マイグレーション、シードデータ。SQLite をローカル `server/var/app.db` に保存。|

デプロイは単一アプリ（Node.js）＋静的 SPA 配信を想定している。認証はデモユーザー（`demo-user`）のみを持ち、アプリ起動時に自動挿入される。

---

## 2. バックエンド詳細

### 2.1 ディレクトリ構成

```
server/
 ├─ src/domain        # 型定義、進捗ロジック
 ├─ src/application   # projectService（ユースケース）
 ├─ src/infrastructure
 │   ├─ db.ts / migrations.ts / seed.ts
 │   └─ repositories/ (project & hierarchy)
 └─ src/presentation  # Express エンドポイント
```

### 2.2 ドメインモデル

* **Project**: プロジェクト本体。Owner は常に `demo-user`。`todoCounts` と `progress` はアプリケーション層で計算。
* **Phase / Work / Task**: 計画階層。共通列 `title`, `plannedStart`, `plannedEnd`, `actualStart/End`, `memo`, `orderIndex`, `status`, `projectId`。`status` は `NOT_STARTED | IN_PROGRESS | DONE`。進捗率は即時下位層から算出し、DBには保持しない。
* **Todo**: 最下層。`status`, `assigneeId`, `dueDate`, `todayFlag` を持つ。Task 配下で並び替え可能。

### 2.3 進捗計算

`src/application/projectService.ts` で `progressFromStatus` / `calculateProgressFromStatuses` / `combineProgress` を利用。

1. Task: 自身のステータスを 100/50/0 % に変換して採用。
2. Work: 直下の Task の進捗（= ステータス由来のパーセンテージ）の平均。
3. Phase: 直下の Work の進捗の平均。
4. Project: 直下の Phase の進捗の平均。

ステータスはユーザーが手動更新できるが、進捗率自体は子要素の完了状況のみから算出し、常にリアルタイムで反映される。

### 2.4 データベース

SQLite スキーマは `migrations.ts` で定義。主なテーブル：

* `users`
* `projects`
* `project_members`
* `phases` (status 列付き)
* `works`  (status 列付き)
* `tasks`  (status 列付き)
* `todos`

`better-sqlite3` を直接利用し、Repository 層で SQL を管理。`runMigrations()` でテーブル作成＋不足列を補完し、`seedDemoData()` でデモプロジェクトを挿入。

参照整合性：`ON DELETE CASCADE` により親削除時に子要素も削除される。`todayFlag` は整数（0/1）で保持し、リポジトリで boolean に変換する。

### 2.5 ユースケース / API

`projectService` の主な処理：

| ユースケース | 内容 |
| --- | --- |
| `listProjects` | プロジェクト一覧と Todo 完了状況（件数）+ ステータス由来の進捗率を返却。|
| `getHierarchy` | Phase → Work → Task → Todo をまとめて取得し、進捗を組み立てた JSON を返す。|
| `create/update/delete` 系 | Phase/Work/Task/Todo の CRUD。作成時は `status = NOT_STARTED` を自動設定。|
| `reorder` | 各階層の `orderIndex` を一括更新。|
| `listTodayTodos` | 今日フラグ or 期限が今日の Todo をフィルタ。|

REST エンドポイント（抜粋）：

| メソッド | パス | 役割 |
| --- | --- | --- |
| `GET /api/projects` | プロジェクト一覧。
| `POST /api/projects` / `DELETE /api/projects/:id` | プロジェクト作成・削除。
| `GET /api/projects/:id/hierarchy` | プロジェクト階層取得。
| `POST /api/projects/:id/(phases|works|tasks|todos)` | 各階層の作成。
| `PATCH /api/(phases|works|tasks|todos)/:id` | タイトル/日付/メモ/ステータス更新。
| `DELETE /api/(phases|works|tasks|todos)/:id` | 個別削除。
| `GET /api/projects/:id/today-todos` | 今日の Todo 抽出。
| `POST /api/reorder` | 任意階層の並び順更新。

Zod でスキーマを定義し、リクエストのバリデーションを行っている。

---

## 3. フロントエンド詳細

### 3.1 主要コンポーネント

| コンポーネント | 役割 |
| --- | --- |
| `App.tsx` | ルートコンテナ。プロジェクト一覧・選択状態・階層データ・今日の Todo を管理。`api.ts` を通じて REST API と通信。|
| `ProjectSidebar` | プロジェクト一覧、再読込、新規作成フォーム、削除ボタン。選択したプロジェクトを `App` に通知。|
| `HierarchyView` | Phase/Work/Task/Todo を縦階層で表示。インライン編集、ステータス切り替え、Today フラグ、追加・削除ボタンを提供。|
| `StatusSelect` / `InlineInput` | 共通 UI。非同期で保存処理を呼び出し、失敗時はアラート表示。|
| `TodayPanel` | 今日対応すべき Todo リスト。状態更新のみ許可。|

すべての更新系操作は `mutate()` を経由し、成功後に階層・今日の Todo を再フェッチして整合性を保つ。削除や Todo 更新など成果物数に影響する操作はプロジェクト一覧も再度取得することでカード上の進捗値と Todo 数を同期させている。

### 3.2 状態管理と通信

React のローカル state + `useEffect` で以下を管理：

* `projects`: プロジェクトカード。
* `selectedProjectId`: サイドバー連動。
* `hierarchy`: 現在選択中プロジェクトの階層。
* `todayTodos`: 今日の Todo。
* `error`: 画面上部のアラートに表示。

API 呼び出しは `api.ts` 経由で統一。`fetchProjects`, `fetchHierarchy`, `createTodo`, `deleteWork` 等すべてここで宣言し、`Content-Type: application/json` を固定。リクエスト失敗時は `Error` を投げ、呼び出し側でアラート文言を設定する。

### 3.3 UI 挙動

* 各階層はインライン編集。`blur`/`Enter` で自動保存、`Escape` でリセット。
* ステータスは `StatusSelect` で変更。Phase/Work/Task/Todo すべてが同一 UI を共有。
* 削除ボタンは `✕` アイコンで提供し、`window.confirm` で確認する。
* 「今日の Todo」は Today フラグ or 期限が当日のものを表示し、ステータス変更のみ許可。削除は主階層ビューから行う。

---

## 4. 主要フロー

1. **アプリ起動**
   * サーバー起動時にマイグレーション＆デモデータ投入。
   * フロントは `GET /api/projects` で一覧を取得し、先頭プロジェクトを選択。
2. **階層編集**
   * 追加ボタンで Phase/Work/Task/Todo を作成。バックエンドで `status = NOT_STARTED` を付与。
   * 編集・削除・並び替え時は `mutate()` が実行され、階層と Today Todo を再取得。必要に応じて一覧も再ロード。
3. **進捗反映**
   * Todo ステータスを `DONE` に変更 → Task.progress が再計算 → Work/Phase.progress も自動的に再計算され、UI に反映。
   * Todo ステータスを `DONE` に変更 → Task.progress が再計算
   * Task ステータスを 

---

## 5. 非機能・拡張性

* **性能**: SQLite + in-memory 結果組み立てで小規模（1,000 Todo 程度）を想定。必要に応じて進捗キャッシュやページングを導入可能。
* **信頼性**: すべての削除が外部キーでカスケードするため、孤児レコードは発生しない。`runMigrations()` が不足列を補完するため、既存 DB でもアップデート可能。
* **拡張余地**: 認証導入、メンバー管理、コメント・通知、タグ等は Application 層を追加／Repository 拡張で対応可能。REST API を GraphQL に置き換える場合もドメイン層はそのまま利用できる。

---

## 6. 参照ファイル

| 目的 | ファイル |
| --- | --- |
| API 定義/ハンドラ | `server/src/presentation/server.ts` |
| ユースケース | `server/src/application/projectService.ts` |
| ドメインモデル | `server/src/domain/entities.ts`, `server/src/domain/progress.ts` |
| Repository | `server/src/infrastructure/repositories/*` |
| クライアント API | `web/src/api.ts` |
| UI コンポーネント | `web/src/components/*.tsx` |

この仕様書は、初めて参加するメンバーが「どのディレクトリに何があり、どの層がどの責務を持つのか」「なぜ進捗が自動で計算されるのか」「どの API がどの UI 操作に紐づくのか」を把握できることを目標としている。EOF
